#!/bin/bash

set -e

# Define teardown function
teardown() {
    echo "Stopping Tailscale..."
    tailscale logout
    exit 0
}

# Set trap for SIGTERM and SIGINT
trap teardown SIGTERM SIGINT

# Load secrets from ~/.env
if [ -f ~/.env ]; then
    export $(grep -v '^#' ~/.env | xargs)
fi

# Call GitHub API
GITHUB_USER=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/user)
GITHUB_EMAILS=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/user/emails)

# Import authorized SSH keys
mkdir -p ~/.ssh
curl -s https://github.com/$(echo $GITHUB_USER | jq -r .login).keys > ~/.ssh/authorized_keys

# Configure Git
git config --global user.name "$(echo $GITHUB_USER | jq .name)"
git config --global user.email "$(echo $GITHUB_EMAILS | jq .[0].email)"
git config --global github.user "$(echo $GITHUB_USER | jq .login)"
git config --global sendemail.smtpUser "$(echo $GITHUB_EMAILS | jq .[0].email)"

# Start PostgreSQL
echo "Starting PostgreSQL..."
sudo service postgresql start > /dev/null 2>&1
sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'postgres';" > /dev/null 2>&1 || true

# Start Redis
echo "Starting Redis..."
sudo redis-server --daemonize yes > /dev/null 2>&1

# Start Tailscale
echo "Starting Tailscale..."
sudo tailscaled --tun=userspace-networking --socks5-server=localhost:1055 --outbound-http-proxy-listen=localhost:1055 > /dev/null 2>&1 &
sudo tailscale up --operator=$(whoami) --auth-key=$TAILSCALE_KEY --accept-routes --ssh --hostname=dev

# Check if a TTY is attached (i.e., `docker run -it`)
if [ -t 0 ] ; then
    # Start interactive fish shell if TTY is available
    /bin/fish && teardown
else
    # Non-interactive mode - run main loop to keep the container alive
    while true; do
        sleep 1
    done
fi
